<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Player â€¢ GuruKulX</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/quiz-player.css">
    <link rel="icon" href="/assets/images/logo.png" type="image/png" />
    <script defer src="/js/main.js"></script>
</head>

<body data-page="quiz-player">
    <header id="site-header"></header>

    <main class="container">
        <section class="quiz-hero" id="quizHero">
            <div class="breadcrumb">
                <a href="/index.html">Home</a>
                <i class="ri-arrow-right-s-line"></i>
                <a href="#" id="quizSelectionLink">Quizzes</a>
                <i class="ri-arrow-right-s-line"></i>
                <span>Quiz</span>
            </div>

            <div class="hero-content">
                <div class="quiz-icon">
                    <i class="ri-question-line" id="quizIcon"></i>
                </div>
                <h1 class="text-balance" id="quizTitle">Loading Quiz...</h1>
                <p class="lead text-pretty" id="quizDescription">Please wait...</p>
                <div class="quiz-info" id="quizInfo" style="display: none;">
                    
                </div>
            </div>
        </section>

        <section class="quiz-container" id="quizContainer" style="display: none;">
            <div class="quiz-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="currentQuestion">1</span> of <span id="totalQuestions">0</span>
                </div>
            </div>

            <div class="quiz-content">
                <div class="question-card" id="questionCard">
                    <div class="question-header">
                        <h3 id="questionText">Loading question...</h3>
                        <div class="question-number" id="questionNumber">Question 1</div>
                    </div>

                    <div class="question-options" id="questionOptions">
                        
                    </div>

                    <div class="question-actions">
                        <button class="btn-secondary" id="prevBtn" disabled>
                            <i class="ri-arrow-left-line"></i>
                            Previous
                        </button>
                        <button class="btn-primary" id="nextBtn">
                            Next
                            <i class="ri-arrow-right-line"></i>
                        </button>
                        <button class="btn-success" id="submitBtn" style="display: none;">
                            <i class="ri-check-line"></i>
                            Submit Quiz
                        </button>
                    </div>
                </div>
            </div>

            <div class="quiz-results" id="quizResults" style="display: none;">
                <div class="results-header">
                    <div class="score-icon">
                        <i class="ri-trophy-line"></i>
                    </div>
                    <h2>Quiz Completed!</h2>
                    <p>Here are your results:</p>
                </div>

                <div class="score-display">
                    <div class="score-circle">
                        <span class="score-number" id="finalScore">0</span>
                        <span class="score-total" id="scoreTotal">/ 0</span>
                    </div>
                    <div class="score-percentage" id="scorePercentage">0%</div>
                </div>

                <div class="score-details">
                    <div class="detail-item">
                        <span class="detail-label">Correct Answers:</span>
                        <span class="detail-value" id="correctAnswers">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Incorrect Answers:</span>
                        <span class="detail-value" id="incorrectAnswers">0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Time Taken:</span>
                        <span class="detail-value" id="timeTaken">0:00</span>
                    </div>
                </div>

                <div class="performance-message" id="performanceMessage">
                    
                </div>

                <div class="results-actions">
                    <button class="btn-primary" id="retakeBtn">
                        <i class="ri-refresh-line"></i>
                        Retake Quiz
                    </button>
                    <a href="#" id="backToQuizzesLink" class="btn-secondary">
                        <i class="ri-arrow-left-line"></i>
                        Back to Quizzes
                    </a>
                </div>
            </div>
        </section>
    </main>

    <footer id="site-footer"></footer>

    <script>
        let quizData = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime = Date.now();
        let quizCompleted = false;
        let quizId = null;
        let subject = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadQuiz();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('prevBtn').addEventListener('click', previousQuestion);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('submitBtn').addEventListener('click', submitQuiz);
            document.getElementById('retakeBtn').addEventListener('click', retakeQuiz);
        }

        async function loadQuiz() {
            const urlParams = new URLSearchParams(window.location.search);
            quizId = urlParams.get('id');
            subject = urlParams.get('subject') || 'General';

            if (!quizId) {
                alert('No quiz selected');
                window.location.href = '/quiz-selection.html';
                return;
            }

            // Update breadcrumb link
            document.getElementById('quizSelectionLink').href = `/quiz-selection.html?subject=${encodeURIComponent(subject)}`;
            document.getElementById('backToQuizzesLink').href = `/quiz-selection.html?subject=${encodeURIComponent(subject)}`;

            try {
                // Try to fetch from server
                const apiBase = window.GX_API_BASE || localStorage.getItem('GX_API_BASE') || 'http://localhost:8080';
                const res = await fetch(`${apiBase.replace(/\/$/, '')}/api/quizzes/${quizId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('GX_TOKEN')}`
                    }
                });

                if (res.ok) {
                    quizData = await res.json();
                }
            } catch (err) {
                console.error('Failed to fetch quiz from server:', err);
            }

            // Fallback to local storage
            if (!quizData) {
                const allQuizzes = JSON.parse(localStorage.getItem('gx_quizzes') || '[]');
                quizData = allQuizzes.find(q => (q.id || q._id) === quizId);
            }

            if (!quizData || !quizData.questions || quizData.questions.length === 0) {
                alert('Quiz not found or has no questions');
                window.location.href = '/quiz-selection.html';
                return;
            }

            initializeQuiz();
        }

        function initializeQuiz() {
            // Update hero section
            document.getElementById('quizTitle').textContent = quizData.title || `${subject} Quiz`;
            document.getElementById('quizDescription').textContent = quizData.description || 'Test your knowledge';

            const quizInfo = document.getElementById('quizInfo');
            quizInfo.style.display = 'flex';
            quizInfo.innerHTML = `
        <div class="info-item">
          <i class="ri-question-line"></i>
          <span>${quizData.questions.length} Questions</span>
        </div>
        ${quizData.timeLimit ? `
          <div class="info-item">
            <i class="ri-time-line"></i>
            <span>${quizData.timeLimit} Minutes</span>
          </div>
        ` : ''}
        ${quizData.difficulty ? `
          <div class="info-item">
            <i class="ri-star-line"></i>
            <span>${quizData.difficulty} Level</span>
          </div>
        ` : ''}
      `;

            // Initialize quiz state
            userAnswers = new Array(quizData.questions.length).fill(null);
            currentQuestionIndex = 0;
            startTime = Date.now();
            quizCompleted = false;

            // Show quiz container
            document.getElementById('quizContainer').style.display = 'block';

            // Display first question
            displayQuestion();
            updateProgress();
        }

        function displayQuestion() {
            const question = quizData.questions[currentQuestionIndex];

            document.getElementById('questionText').textContent = question.question || question.text;
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex + 1}`;

            const optionsContainer = document.getElementById('questionOptions');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                if (userAnswers[currentQuestionIndex] === index) {
                    optionElement.classList.add('selected');
                }

                optionElement.innerHTML = `
          <input type="radio" name="question" value="${index}" id="option${index}" ${userAnswers[currentQuestionIndex] === index ? 'checked' : ''}>
          <label for="option${index}">
            <span class="option-letter">${String.fromCharCode(65 + index)}</span>
            <span class="option-text">${option}</span>
          </label>
        `;

                optionElement.addEventListener('click', () => selectOption(index));
                optionsContainer.appendChild(optionElement);
            });

            updateNavigationButtons();
        }

        function selectOption(index) {
            userAnswers[currentQuestionIndex] = index;
            displayQuestion();
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / quizData.questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = quizData.questions.length;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.disabled = currentQuestionIndex === 0;

            if (currentQuestionIndex === quizData.questions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                submitBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                updateProgress();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
                updateProgress();
            }
        }

        async function submitQuiz() {
            if (quizCompleted) return;

            quizCompleted = true;
            const endTime = Date.now();
            const timeTaken = Math.floor((endTime - startTime) / 1000);

            let correctAnswers = 0;

            quizData.questions.forEach((question, index) => {
                const isCorrect = userAnswers[index] === question.correct;
                if (isCorrect) correctAnswers++;
            });

            const score = correctAnswers;
            const percentage = Math.round((score / quizData.questions.length) * 100);

            // Hide quiz content and show results
            document.querySelector('.quiz-content').style.display = 'none';
            document.getElementById('quizResults').style.display = 'block';

            // Update results display
            document.getElementById('finalScore').textContent = score;
            document.getElementById('scoreTotal').textContent = `/ ${quizData.questions.length}`;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('incorrectAnswers').textContent = quizData.questions.length - correctAnswers;
            document.getElementById('timeTaken').textContent = formatTime(timeTaken);

            // Update performance message
            const performanceMessage = document.getElementById('performanceMessage');
            if (percentage >= 90) {
                performanceMessage.innerHTML = '<div class="message excellent">Excellent! You have mastered this topic!</div>';
            } else if (percentage >= 70) {
                performanceMessage.innerHTML = '<div class="message good">Good job! You understand most concepts well.</div>';
            } else if (percentage >= 50) {
                performanceMessage.innerHTML = '<div class="message fair">Fair performance. Consider reviewing the material.</div>';
            } else {
                performanceMessage.innerHTML = '<div class="message poor">You need more practice. Please review the material thoroughly.</div>';
            }

            // Save score to backend
            try {
                const apiBase = window.GX_API_BASE || localStorage.getItem('GX_API_BASE') || 'http://localhost:8080';
                await fetch(`${apiBase.replace(/\/$/, '')}/api/quiz-results`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('GX_TOKEN')}`
                    },
                    body: JSON.stringify({
                        quizId: quizId,
                        score: score,
                        totalQuestions: quizData.questions.length,
                        percentage: percentage,
                        timeTaken: timeTaken
                    })
                });
            } catch (err) {
                console.error('Failed to save quiz results:', err);
            }

            // Save score using existing game results function
            if (window.saveGameResults) {
                const xpEarned = score * 10;
                const progressEarned = Math.min(5, Math.floor(percentage / 20));
                await window.saveGameResults(score * 10, xpEarned, progressEarned);
            }
        }

        function retakeQuiz() {
            currentQuestionIndex = 0;
            userAnswers = new Array(quizData.questions.length).fill(null);
            startTime = Date.now();
            quizCompleted = false;

            document.querySelector('.quiz-content').style.display = 'block';
            document.getElementById('quizResults').style.display = 'none';

            displayQuestion();
            updateProgress();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>

</html>