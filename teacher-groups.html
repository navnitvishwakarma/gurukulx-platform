<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Groups â€¢ GuruKulX</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" href="/assets/images/logo.png" type="image/png" />
  <script defer src="/js/main.js"></script>
  <style>
    .groups {
      max-width: 900px;
      margin: 1rem auto;
      display: grid;
      gap: 1rem;
    }

    .group {
      border: 1px solid var(--color-muted);
      border-radius: .75rem;
      padding: 1rem;
    }

    .group header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .5rem;
    }

    .member {
      display: flex;
      justify-content: space-between;
      padding: .4rem 0;
      border-top: 1px solid var(--color-muted);
    }

    .member:first-child {
      border-top: none;
    }
  </style>
</head>

<body data-page="teacher-groups">
  <header id="site-header"></header>
  <main class="container">
    <section class="card groups">
      <h1>Manage Groups</h1>
      <form id="groupForm" class="form">
        <div class="form-row">
          <label for="groupName">Group Name</label>
          <input id="groupName" placeholder="e.g., Grade 6 - Eco Champions" required />
        </div>
        <div class="form-row">
          <label for="groupClass">Class</label>
          <select id="groupClass" required></select>
        </div>
        <div class="form-row">
          <button class="btn btn-primary" type="submit">Create Group</button>
        </div>
      </form>
      <div id="groupList"></div>
    </section>
  </main>
  <footer id="site-footer"></footer>
  <script>
    <script>
      document.addEventListener('DOMContentLoaded', () => setTimeout(initGroups, 100));

      async function initGroups() {
        // Fetch existing classrooms
        await renderGroups();

      // Classes dropdown (still useful for filtering or assigning grade level)
      const classes = JSON.parse(localStorage.getItem('gx_classes') || '[]');
      const classSelect = document.getElementById('groupClass');
      if (classSelect) {
        classSelect.innerHTML = classes.map(c => `<option value="${c.name}">${c.fullName || ('Grade ' + c.name)}</option>`).join('');
        }

        // Handle form submission
        document.getElementById('groupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
      const name = document.getElementById('groupName').value.trim();
      const subject = document.getElementById('groupClass').value; // Using class as subject/grade for now

      try {
            const apiBase = window.GX_API_BASE || localStorage.getItem('GX_API_BASE') || '/';
      const res = await fetch(`${apiBase.replace(/\/$/, '')}/api/classrooms`, {
        method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('GX_TOKEN')}`
              },
      body: JSON.stringify({name, subject})
            });

      if (res.ok) {
        alert('Group created successfully!');
      e.target.reset();
      renderGroups();
            } else {
        alert('Failed to create group');
            }
          } catch (err) {
        console.error(err);
      alert('Error creating group');
          }
        });
      }

      async function renderGroups() {
        const root = document.getElementById('groupList');
      root.innerHTML = '<p>Loading...</p>';

      try {
          const apiBase = window.GX_API_BASE || localStorage.getItem('GX_API_BASE') || '/';
      const res = await fetch(`${apiBase.replace(/\/$/, '')}/api/classrooms`, {
        headers: {
        'Authorization': `Bearer ${localStorage.getItem('GX_TOKEN')}`
            }
          });

      if (res.ok) {
            const list = await res.json();
      if (!list.length) {
        root.innerHTML = '<div class="empty-state"><i class="ri-team-line"></i><p>No groups yet</p></div>';
      return;
            }

            root.innerHTML = list.map(g => `
      <div class="group">
        <header>
          <div>
            <strong>${g.name}</strong>
            <div class="muted">Subject: ${g.subject}</div>
            <div class="muted">Code: <strong>${g.code}</strong></div>
          </div>
                  <!-- Delete not implemented in API yet, hiding button -->
        </header>
        <div class="form-row">
          <label>Members (${g.students.length})</label>
          <div class="flex-row gap">
            <!-- Add member logic would go here if API supported direct add -->
          </div>
        </div>
        <div>
          ${g.students.map(s => `<div class="member"><span>${s.name || 'Student'}</span></div>`).join('') || '<div class="muted">No members joined yet</div>'}
        </div>
      </div>
            `).join('');
          } else {
            root.innerHTML = '<p>Failed to load groups.</p>';
          }
        } catch (err) {
          console.error(err);
          root.innerHTML = '<p>Error loading groups.</p>';
        }
      }
  </script>
  </script>
</body>

</html>