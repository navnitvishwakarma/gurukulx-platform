<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact & Help • GuruKulX</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script defer src="/js/main.js"></script>
  <style>
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <header id="site-header"></header>
  <main class="container">
    <section class="grid grid-3">
      <div class="card">
        <h2>Feedback</h2>
        <form id="feedbackForm" class="form">
          <div class="form-row"><label for="fb-name">Name</label><input id="fb-name" required /></div>
          <div class="form-row"><label for="fb-email">Email</label><input id="fb-email" type="email" required /></div>
          <div class="form-row"><label for="fb-msg">Message</label><textarea id="fb-msg" required></textarea></div>
          <button class="btn btn-primary" type="submit">Send Feedback</button>
        </form>
      </div>
      <div class="card">
        <h2>Help / FAQ</h2>
        <ul class="list">
          <li><strong>How to start?</strong> Log in and open your subject page to pick a game.</li>
          <li><strong>Save progress?</strong> Automatically saved on your device.</li>
          <li><strong>Need support?</strong> Use Ask a Doubt to contact a teacher.</li>
        </ul>
      </div>
      <div class="card" id="ask-doubt">
        <h2>Ask a Doubt</h2>
        <form id="doubtForm" class="form">
          <div class="form-row"><label for="doubt-subject">Subject</label>
            <select id="doubt-subject">
              <option>Math</option>
              <option>Science</option>
              <option>Environment</option>
              <option>Social Science</option>
              <option>English</option>
              <option>Computer Science</option>
              <option>GK</option>
            </select>
          </div>
          <div class="form-row"><label for="doubt-msg">Your Doubt</label><textarea id="doubt-msg" required></textarea>
          </div>
          <button class="btn btn-accent" type="submit">Submit Doubt</button>
        </form>
        <div id="aiAnswer" style="margin-top:1rem; display:none;">
          <div class="card" style="border:1px solid var(--color-muted);">
            <h3 style="margin:0 0 .5rem;">AI Suggestion</h3>
            <div id="aiAnswerContent" class="text-pretty"></div>
          </div>
        </div>
      </div>

      
    </section>
  </main>
  <footer id="site-footer"></footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const geminiForm = document.getElementById('geminiSearchForm');
      const geminiQuery = document.getElementById('geminiQuery');
      const geminiAnswer = document.getElementById('geminiAnswer');
      const geminiAnswerContent = document.getElementById('geminiAnswerContent');
      const geminiLoading = document.getElementById('geminiLoading');
      const voiceSearchBtn = document.getElementById('voiceSearchBtn');
      const micIcon = document.getElementById('micIcon');
      const copyResponseBtn = document.getElementById('copyResponseBtn');

      // Check for teacher role and hide Ask Doubt section
      try {
        const userJson = localStorage.getItem("gx_user");
        if (userJson) {
          const user = JSON.parse(userJson);
          if (user.role === 'teacher') {
            const askDoubtSection = document.getElementById('ask-doubt');
            if (askDoubtSection) {
              askDoubtSection.style.display = 'none';
              // Adjust layout to 2 columns so Feedback and FAQ fill the width
              if (askDoubtSection.parentElement) {
                askDoubtSection.parentElement.classList.remove('grid-3');
                askDoubtSection.parentElement.classList.add('grid-2');
              }
            }
          }
        }
      } catch (e) {
        console.error("Error checking user role:", e);
      }

      // API Configuration
      const API_BASE_URL = window.location.origin;
      const AI_ENDPOINT = `${API_BASE_URL}/api/ai`;

      async function searchWithGemini(query) {
        try {
          console.log('Attempting to connect to Gemini AI (Backend)...');
          console.log('Query:', query);

          // Create a more educational prompt
          const educationalPrompt = `You are an AI tutor for GuruKulX, an educational platform. Please provide a helpful, educational response to this student question: "${query}". 
            
            Guidelines:
            - Keep responses clear and age-appropriate for students
            - If it's a math question, show step-by-step solutions
            - If it's a general knowledge question, provide accurate information
            - If it's about study tips or learning, give practical advice
            - Keep responses concise but informative (2-3 paragraphs max)
            - Use simple language that students can understand`;

          const token = localStorage.getItem('GX_TOKEN');
          const headers = { 'Content-Type': 'application/json' };
          if (token) headers['Authorization'] = `Bearer ${token}`;

          const response = await fetch(AI_ENDPOINT, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              subject: 'General',
              question: educationalPrompt // The backend will use this as part of its own prompt, but here we are sending the prompt directly as 'question' or we can rely on backend prompt. 
              // Wait, server-mongodb.js wraps the question in a prompt.
              // So I should just send the query as 'question'.
            })
          });

          // Correction: The backend wraps the question in a prompt. 
          // If I send the prompt as the question, it will be double prompted.
          // Let's just send the raw query to the backend, as the backend has the system prompt.
          // Re-doing the fetch call logic below to correct this.

        } catch (error) {
          // ...
        }
      }

      // Corrected implementation
      async function searchWithGemini(query) {
        try {
          console.log('Attempting to connect to Gemini AI (Backend)...');
          const token = localStorage.getItem('GX_TOKEN');
          const headers = { 'Content-Type': 'application/json' };
          if (token) headers['Authorization'] = `Bearer ${token}`;

          const response = await fetch(AI_ENDPOINT, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              subject: 'General',
              question: query // Backend handles the system prompt
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          if (data.answer) {
            return data.answer;
          } else {
            throw new Error('No answer received');
          }
        } catch (error) {
          console.error('Error calling Gemini API:', error);
          if (error.message.includes('API error')) {
            throw new Error('AI service is temporarily unavailable.');
          } else {
            throw new Error('Sorry, I encountered an error. Please try again.');
          }
        }
      }

      // Voice search functionality
      let recognition = null;
      let isListening = false;

      // Check if browser supports speech recognition
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = function () {
          isListening = true;
          micIcon.className = 'ri-mic-fill';
          voiceSearchBtn.style.background = '#dc2626';
          voiceSearchBtn.title = 'Listening... Click to stop';
        };

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          geminiQuery.value = transcript;
          isListening = false;
          micIcon.className = 'ri-mic-line';
          voiceSearchBtn.style.background = '';
          voiceSearchBtn.title = 'Voice Search';
        };

        recognition.onerror = function (event) {
          console.error('Speech recognition error:', event.error);
          isListening = false;
          micIcon.className = 'ri-mic-line';
          voiceSearchBtn.style.background = '';
          voiceSearchBtn.title = 'Voice Search';
          alert('Voice search failed. Please try again.');
        };

        recognition.onend = function () {
          isListening = false;
          micIcon.className = 'ri-mic-line';
          voiceSearchBtn.style.background = '';
          voiceSearchBtn.title = 'Voice Search';
        };
      } else {
        voiceSearchBtn.style.display = 'none';
      }

      voiceSearchBtn.addEventListener('click', function () {
        if (!recognition) return;

        if (isListening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });

      geminiForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const query = geminiQuery.value.trim();
        if (!query) {
          alert('Please enter a question to ask the AI.');
          return;
        }

        // Show loading state
        geminiAnswer.style.display = 'none';
        geminiLoading.style.display = 'block';

        // Disable form during processing
        const submitBtn = geminiForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Searching...';

        try {
          const response = await searchWithGemini(query);

          // Hide loading and show response
          geminiLoading.style.display = 'none';
          geminiAnswerContent.innerHTML = response.replace(/\n/g, '<br>');
          geminiAnswer.style.display = 'block';

          // Clear the input after successful response
          geminiQuery.value = '';

        } catch (error) {
          // Hide loading and show error
          geminiLoading.style.display = 'none';
          geminiAnswerContent.innerHTML = `
              <div style="color: #dc2626; padding: 1rem; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                <strong>Error:</strong> ${error.message}
                <br><br>
                <small>Please try again or check your internet connection.</small>
              </div>
            `;
          geminiAnswer.style.display = 'block';
          console.error('Gemini search error:', error);
        } finally {
          // Re-enable form
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });

      // Copy response functionality
      copyResponseBtn.addEventListener('click', function () {
        const responseText = geminiAnswerContent.textContent || geminiAnswerContent.innerText;
        if (responseText) {
          navigator.clipboard.writeText(responseText).then(() => {
            const originalText = copyResponseBtn.innerHTML;
            copyResponseBtn.innerHTML = '<i class="ri-check-line"></i> Copied!';
            copyResponseBtn.style.background = '#16a34a';
            copyResponseBtn.style.color = 'white';

            setTimeout(() => {
              copyResponseBtn.innerHTML = originalText;
              copyResponseBtn.style.background = '';
              copyResponseBtn.style.color = '';
            }, 2000);
          }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy response. Please select and copy manually.');
          });
        }
      });

      // Allow Enter key to submit form
      geminiQuery.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          geminiForm.dispatchEvent(new Event('submit'));
        }
      });

      // Clear response when user starts typing a new question
      geminiQuery.addEventListener('input', function () {
        if (geminiAnswer.style.display !== 'none') {
          geminiAnswer.style.display = 'none';
        }
      });

      // Test function for debugging (can be called from browser console)
      window.testAskAI = async function () {
        console.log('Testing Ask AI functionality...');
        try {
          const testQuery = 'What is 2 + 2?';
          console.log('Test query:', testQuery);
          const response = await searchWithGemini(testQuery);
          console.log('✅ Ask AI test successful:', response);
          return response;
        } catch (error) {
          console.error('❌ Ask AI test failed:', error);
          throw error;
        }
      };
    });
  </script>
</body>

</html>