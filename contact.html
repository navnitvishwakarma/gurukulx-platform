<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Contact & Help â€¢ GuruKulX</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script defer src="/js/main.js"></script>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <header id="site-header"></header>
    <main class="container">
      <section class="grid grid-3">
        <div class="card">
          <h2>Feedback</h2>
          <form id="feedbackForm" class="form">
            <div class="form-row"><label for="fb-name">Name</label><input id="fb-name" required /></div>
            <div class="form-row"><label for="fb-email">Email</label><input id="fb-email" type="email" required /></div>
            <div class="form-row"><label for="fb-msg">Message</label><textarea id="fb-msg" required></textarea></div>
            <button class="btn btn-primary" type="submit">Send Feedback</button>
          </form>
        </div>
        <div class="card">
          <h2>Help / FAQ</h2>
          <ul class="list">
            <li><strong>How to start?</strong> Log in and open your subject page to pick a game.</li>
            <li><strong>Save progress?</strong> Automatically saved on your device.</li>
            <li><strong>Need support?</strong> Use Ask a Doubt to contact a teacher.</li>
          </ul>
        </div>
        <div class="card" id="ask-doubt">
          <h2>Ask a Doubt</h2>
          <form id="doubtForm" class="form">
            <div class="form-row"><label for="doubt-subject">Subject</label>
              <select id="doubt-subject"><option>Math</option><option>Science</option><option>Environment</option><option>Social Science</option><option>English</option><option>Computer Science</option><option>GK</option></select>
            </div>
            <div class="form-row"><label for="doubt-msg">Your Doubt</label><textarea id="doubt-msg" required></textarea></div>
            <button class="btn btn-accent" type="submit">Submit Doubt</button>
          </form>
          <div id="aiAnswer" style="margin-top:1rem; display:none;">
            <div class="card" style="border:1px solid var(--color-muted);">
              <h3 style="margin:0 0 .5rem;">AI Suggestion</h3>
              <div id="aiAnswerContent" class="text-pretty"></div>
            </div>
          </div>
        </div>

        <div class="card" style="grid-column: 1 / -1; max-width: 100%;">
          <h2>Ask AI</h2>
          <p>Get instant answers powered by Google's Gemini AI. Use text or voice search.</p>
          <form id="geminiSearchForm" class="form" style="margin-top: 1rem;">
            <div class="search-container" style="display: flex; gap: 8px; width: 100%; margin-bottom: 1rem;">
              <input type="text" id="geminiQuery" placeholder="Ask AI anything..." required style="flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; min-width: 0;">
              <button type="button" id="voiceSearchBtn" class="btn btn-secondary" style="padding: 12px; border-radius: 8px; min-width: 50px;" title="Voice Search">
                <i class="ri-mic-line" id="micIcon"></i>
              </button>
              <button type="submit" class="btn btn-primary" style="padding: 12px 20px; border-radius: 8px;">
                <i class="ri-search-line"></i> Search
              </button>
            </div>
          </form>
          <div id="geminiAnswer" style="margin-top: 1rem; display: none;">
            <div class="card" style="border: 1px solid var(--color-muted);">
              <h3 style="margin: 0 0 0.5rem;">AI Response</h3>
              <div id="geminiAnswerContent" class="text-pretty"></div>
            </div>
          </div>
          <div id="geminiLoading" style="display: none; text-align: center; padding: 1rem;">
            <div style="border: 3px solid #f3f3f3; border-top: 3px solid #16a34a; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
            <p>Searching with AI...</p>
          </div>
        </div>
      </section>
    </main>
    <footer id="site-footer"></footer>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const geminiForm = document.getElementById('geminiSearchForm');
        const geminiQuery = document.getElementById('geminiQuery');
        const geminiAnswer = document.getElementById('geminiAnswer');
        const geminiAnswerContent = document.getElementById('geminiAnswerContent');
        const geminiLoading = document.getElementById('geminiLoading');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const micIcon = document.getElementById('micIcon');
        
        const GEMINI_API_KEY = 'AIzaSyALj_4-lYI__CEE9u14RkQAIYCsvN0H6Do';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        
        async function searchWithGemini(query) {
          try {
            console.log('Attempting to connect to Gemini AI...');
            console.log('Query:', query);
            
            // First try direct API call
            try {
              const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: query
                    }]
                  }]
                })
              });
              
              console.log('Direct API Response status:', response.status);
              
              if (response.ok) {
                const data = await response.json();
                console.log('Direct API Response:', data);
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                  return data.candidates[0].content.parts[0].text;
                }
              }
            } catch (directError) {
              console.log('Direct API failed, trying CORS proxy...', directError);
              
              // Fallback to CORS proxy
              const proxyUrl = `${CORS_PROXY}${encodeURIComponent(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`)}`;
              
              const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: query
                    }]
                  }]
                })
              });
              
              console.log('CORS Proxy Response status:', response.status);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
              }
              
              const data = await response.json();
              console.log('CORS Proxy API Response:', data);
              
              if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
              } else {
                console.error('Unexpected API response structure:', data);
                throw new Error('No response from Gemini AI');
              }
            }
            
            throw new Error('No response from Gemini AI');
          } catch (error) {
            console.error('Error calling Gemini API:', error);
            
            // Provide a helpful error message
            if (error.message.includes('CORS') || error.message.includes('cross-origin')) {
              throw new Error('CORS Error: The API cannot be called directly from the browser. Please check the browser console for more details.');
            }
            
            throw error;
          }
        }
        
        // Voice search functionality
        let recognition = null;
        let isListening = false;
        
        // Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';
          
          recognition.onstart = function() {
            isListening = true;
            micIcon.className = 'ri-mic-fill';
            voiceSearchBtn.style.background = '#dc2626';
            voiceSearchBtn.title = 'Listening... Click to stop';
          };
          
          recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            geminiQuery.value = transcript;
            isListening = false;
            micIcon.className = 'ri-mic-line';
            voiceSearchBtn.style.background = '';
            voiceSearchBtn.title = 'Voice Search';
          };
          
          recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            micIcon.className = 'ri-mic-line';
            voiceSearchBtn.style.background = '';
            voiceSearchBtn.title = 'Voice Search';
            alert('Voice search failed. Please try again.');
          };
          
          recognition.onend = function() {
            isListening = false;
            micIcon.className = 'ri-mic-line';
            voiceSearchBtn.style.background = '';
            voiceSearchBtn.title = 'Voice Search';
          };
        } else {
          voiceSearchBtn.style.display = 'none';
        }
        
        voiceSearchBtn.addEventListener('click', function() {
          if (!recognition) return;
          
          if (isListening) {
            recognition.stop();
          } else {
            recognition.start();
          }
        });
        
        geminiForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const query = geminiQuery.value.trim();
          if (!query) return;
          
          // Show loading state
          geminiAnswer.style.display = 'none';
          geminiLoading.style.display = 'block';
          
          try {
            const response = await searchWithGemini(query);
            
            // Hide loading and show response
            geminiLoading.style.display = 'none';
            geminiAnswerContent.textContent = response;
            geminiAnswer.style.display = 'block';
            
          } catch (error) {
            // Hide loading and show error
            geminiLoading.style.display = 'none';
            geminiAnswerContent.textContent = 'Sorry, there was an error connecting to AI. Please try again later.';
            geminiAnswer.style.display = 'block';
            console.error('Gemini search error:', error);
          }
        });
      });
    </script>
  </body>
</html>